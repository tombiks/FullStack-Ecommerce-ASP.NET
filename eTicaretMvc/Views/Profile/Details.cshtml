@using AppBusiness.DTOs.ProfileDTOs
@model ProfileDetailDTO
@{
    ViewData["Title"] = "Details";
    ViewData["BreadCrumbTitle"] = "Profile";
    ViewData["BreadCrumbSubtitle"] = "Profile/Details";
}

@section Styles {
    <link rel="stylesheet" href="/theme/css/profile-style.css" asp-append-version="true" />
    <style>
        /* Fix category dropdown styling */
        .modal .form-control {
            height: 45px;
            line-height: 45px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .modal select.form-control {
            padding-top: 0;
            padding-bottom: 0;
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            appearance: menulist;
        }

        .modal label {
            line-height: 1.5;
            margin-bottom: 8px;
        }
    </style>
}

<partial name="Partials/BreadCrumb" />

<!-- Profile Section Begin -->
<section class="profile-section spad">
    <div class="container">
        <div class="main-body">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-column align-items-center text-center">
                                <img src="https://bootdey.com/img/Content/avatar/avatar6.png" alt="Admin" class="rounded-circle p-1 bg-custom-green" width="110">
                                <div class="mt-3">
                                    <h4>@Model.FirstName @Model.LastName</h4>
                                    <p class="btn btn-custom-green">@(Model.IsSeller ? "Seller" : "Customer")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card">
                        <form id="profileForm" asp-action="Edit" asp-controller="Profile" method="post">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Name</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">
                                        <input type="text" name="Name" class="form-control profile-input" value="@Model.FirstName" readonly>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Surname</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">
                                        <input type="hidden" name="userId" value="@Model.UserId" />
                                        <input type="text" name="LastName" class="form-control profile-input" value="@Model.LastName" readonly>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Email</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">
                                        <input type="text" name="Email" class="form-control profile-input" value="@Model.Email" readonly>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-3"></div>
                                    <div class="col-sm-9 text-secondary">
                                        <input type="button" id="editProfileBtn" class="btn btn-primary px-4" value="Edit Profile" onclick="toggleProfileEdit()">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    @if (Model.IsSeller)
                    {
                        int currentPage = int.TryParse(Context.Request.Query["page"], out int page) ? page : 1;
                        int pageSize = 6;
                        int totalProducts = Model.Products?.Count ?? 0;
                        int totalPages = (int)Math.Ceiling(totalProducts / (double)pageSize);
                        int startIndex = (currentPage - 1) * pageSize;
                        int endIndex = Math.Min(startIndex + pageSize, totalProducts);

                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center" id="headingProducts">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-left p-0" type="button" data-toggle="collapse" data-target="#collapseProducts" aria-expanded="true" aria-controls="collapseProducts">
                                                My Products
                                            </button>
                                        </h5>
                                        <button type="button" class="btn btn-custom-green btn-sm" data-toggle="modal" data-target="#addProductModal">
                                            <i class="fa fa-plus mr-2"></i>New Product
                                        </button>
                                    </div>
                                    <div id="collapseProducts" class="collapse show" aria-labelledby="headingProducts">
                                        <div class="card-body">
                                            @if (TempData["SuccessMessage"] != null)
                                            {
                                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                                    @TempData["SuccessMessage"]
                                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                            }
                                            @if (TempData["ErrorMessage"] != null)
                                            {
                                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                                    @TempData["ErrorMessage"]
                                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                            }

                                            @if (Model.Products != null && Model.Products.Any())
                                            {
                                                @for (int i = startIndex; i < endIndex; i++)
                                                {
                                                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                                                        <div>
                                                            <span class="fw-bold mr-3">@Model.Products[i]</span>
                                                            <span class="fw-bold mr-3">@(Model.Categories != null ? Model.Categories[i] : "")</span>
                                                        </div>
                                                        <div>
                                                            <button type="button" class="btn btn-sm btn-primary px-2 mr-3" data-toggle="modal" data-target="#editProductModal-@(Model.ProductIds != null ? Model.ProductIds[i] : 0)">Edit Product</button>
                                                            <button type="button" class="btn btn-sm btn-danger px-2" data-toggle="modal" data-target="#deleteProductModal-@(Model.ProductIds != null ? Model.ProductIds[i] : 0)">Delete Product</button>
                                                        </div>
                                                    </div>
                                                }

                                                @if (totalPages > 1)
                                                {
                                                    <nav aria-label="Product pagination" class="mt-3">
                                                        <ul class="pagination pagination-sm justify-content-center mb-0">
                                                            @if (currentPage > 1)
                                                            {
                                                                <li class="page-item">
                                                                    <a class="page-link" href="?page=@(currentPage - 1)">Previous</a>
                                                                </li>
                                                            }

                                                            @for (int p = 1; p <= totalPages; p++)
                                                            {
                                                                <li class="page-item @(p == currentPage ? "active" : "")">
                                                                    <a class="page-link" href="?page=@p">@p</a>
                                                                </li>
                                                            }

                                                            @if (currentPage < totalPages)
                                                            {
                                                                <li class="page-item">
                                                                    <a class="page-link" href="?page=@(currentPage + 1)">Next</a>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </nav>
                                                }
                                            }
                                            else
                                            {
                                                <p>You have not added any products yet.</p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Product Modals -->
                        @if (Model.Products != null && Model.Products.Any() && Model.ProductIds != null)
                        {
                            @for (int i = 0; i < Model.Products.Count; i++)
                            {
                                var productId = Model.ProductIds[i];
                                <div class="modal fade" id="editProductModal-@productId" tabindex="-1" role="dialog">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Edit Product: @Model.Products[i]</h5>
                                                <button type="button" class="close" data-dismiss="modal">
                                                    <span>&times;</span>
                                                </button>
                                            </div>
                                            <form asp-action="Edit" asp-controller="Product" method="post" enctype="multipart/form-data">
                                                <div class="modal-body">
                                                    <input type="hidden" name="Id" value="@productId" />
                                                    <div class="form-group">
                                                        <label>Product Name</label>
                                                        <input type="text" name="Name" class="form-control" value="@Model.Products[i]" required />
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>Price</label>
                                                                <input type="number" name="Price" class="form-control" step="0.01" required />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>Stock Amount</label>
                                                                <input type="number" name="StockAmount" class="form-control" min="0" max="255" required />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Category</label>
                                                        <select name="CategoryId" class="form-control" required>
                                                            @if (ViewBag.Categories != null)
                                                            {
                                                                foreach (var category in ViewBag.Categories)
                                                                {
                                                                    <option value="@category.Id">@category.Name</option>
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Details</label>
                                                        <textarea name="Details" class="form-control" rows="3"></textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Current Images</label>
                                                        <div id="currentImages-@productId" class="row mb-3"></div>
                                                        <small class="form-text text-muted">Click X to remove an image</small>
                                                    </div>

                                                    <div class="form-group">
                                                        <label>Add New Images (Multiple)</label>
                                                        <input type="file" name="NewImages" class="form-control edit-product-images" accept="image/*" multiple data-product-id="@productId" />
                                                        <small class="form-text text-muted">Select new images to add</small>
                                                    </div>
                                                    <div id="editImagePreview-@productId" class="row mt-3"></div>

                                                    <!-- Container for deleted image IDs (will be populated dynamically) -->
                                                    <div id="deletedImageIdsContainer-@productId"></div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">Update Product</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        }

                        <!-- Delete Product Modals -->
                        @if (Model.Products != null && Model.Products.Any() && Model.ProductIds != null)
                        {
                            @for (int i = 0; i < Model.Products.Count; i++)
                            {
                                <div class="modal fade" id="deleteProductModal-@Model.ProductIds[i]" tabindex="-1" role="dialog" aria-labelledby="deleteProductModalLabel-@Model.ProductIds[i]" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteProductModalLabel-@Model.ProductIds[i]">Delete Product</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <form asp-action="Delete" asp-controller="Product" method="post">
                                                <div class="modal-body">
                                                    <p>Are you sure you want to delete this product?</p>
                                                    <p><strong>@Model.Products[i]</strong></p>
                                                    <p class="text-muted">Category: @(Model.Categories != null ? Model.Categories[i] : "")</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <input type="hidden" name="productId" value="@Model.ProductIds[i]" />
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-danger">Delete</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        }

                        <!-- Add Product Modal -->
                        <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog">
                            <div class="modal-dialog modal-lg" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Add New Product</h5>
                                        <button type="button" class="close" data-dismiss="modal">
                                            <span>&times;</span>
                                        </button>
                                    </div>
                                    <form asp-action="Create" asp-controller="Product" method="post" enctype="multipart/form-data">
                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label>Product Name</label>
                                                <input type="text" name="Name" class="form-control" required />
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Price</label>
                                                        <input type="number" name="Price" class="form-control" step="0.01" required />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Stock Amount</label>
                                                        <input type="number" name="StockAmount" class="form-control" min="0" max="255" required />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>Category</label>
                                                <select name="CategoryId" class="form-control" required>
                                                    <option value="">Select Category</option>
                                                    @if (ViewBag.Categories != null)
                                                    {
                                                        foreach (var category in ViewBag.Categories)
                                                        {
                                                            <option value="@category.Id">@category.Name</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>Details</label>
                                                <textarea name="Details" class="form-control" rows="3"></textarea>
                                            </div>
                                            <div class="form-group">
                                                <label>Product Images (Multiple)</label>
                                                <input type="file" name="Images" class="form-control" accept="image/*" multiple id="addProductImages" />
                                                <small class="form-text text-muted">You can select multiple images</small>
                                            </div>
                                            <div id="addImagePreview" class="row mt-3"></div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-success">Add Product</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                    @if (!Model.IsSeller)
                    {
                        var orders = ViewBag.Orders as List<AppBusiness.DTOs.OrderDTOs.OrderShowDTO>;
                        <div class="row mt-3">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header" id="headingOrders">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-left p-0" type="button" data-toggle="collapse" data-target="#collapseOrders" aria-expanded="true" aria-controls="collapseOrders">
                                                My Orders
                                            </button>
                                        </h5>
                                    </div>
                                    <div id="collapseOrders" class="collapse show" aria-labelledby="headingOrders">
                                        <div class="card-body">
                                            @if (orders != null && orders.Any())
                                            {
                                                <div class="accordion" id="ordersAccordion">
                                                    @foreach (var order in orders)
                                                    {
                                                        <div class="card mb-2">
                                                            <div class="card-header" id="orderHeading-@order.OrderId">
                                                                <h2 class="mb-0">
                                                                    <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#orderCollapse-@order.OrderId" aria-expanded="false" aria-controls="orderCollapse-@order.OrderId">
                                                                        <strong>Order #@order.OrderId</strong> - @order.OrderTime.ToString("yyyy-MM-dd HH:mm") - Total: $@order.OrderTotalPrice.ToString("F2")
                                                                    </button>
                                                                </h2>
                                                            </div>
                                                            <div id="orderCollapse-@order.OrderId" class="collapse" aria-labelledby="orderHeading-@order.OrderId" data-parent="#ordersAccordion">
                                                                <div class="card-body">
                                                                    @if (order.Items != null && order.Items.Any())
                                                                    {
                                                                        <table class="table table-sm">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Product Name</th>
                                                                                    <th>Quantity</th>
                                                                                    <th>Total Price</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                @foreach (var item in order.Items)
                                                                                {
                                                                                    <tr>
                                                                                        <td>@item.ProductName</td>
                                                                                        <td>@item.Quantity</td>
                                                                                        <td>$@item.TotalPrice.ToString("F2")</td>
                                                                                    </tr>
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    }
                                                                    else
                                                                    {
                                                                        <p>No items in this order.</p>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <p>You have no orders yet.</p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Profile Section End -->
@section Scripts {
    <script src="/theme/js/profile-script.js" asp-append-version="true"></script>
    <script>
        
        function toggleProfileEdit() {
            const btn = document.getElementById('editProfileBtn');
            const inputs = document.querySelectorAll('.profile-input');

            if (btn.value === 'Edit Profile') {
                
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.classList.add('border-primary');
                });
                btn.value = 'Save Changes';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-custom-green');
            } else {                
                inputs.forEach(input => {
                    input.setAttribute('readonly', true);
                    input.classList.remove('border-primary');
                });
                btn.value = 'Edit Profile';
                btn.classList.remove('btn-custom-green');
                btn.classList.add('btn-primary');
                
                document.getElementById('profileForm').submit();
            }
        }

        // Add Product - Fotoğraf Önizleme
        document.getElementById('addProductImages').addEventListener('change', function(e) {
            const previewContainer = document.getElementById('addImagePreview');
            previewContainer.innerHTML = ''; // Önceki önizlemeleri temizle

            const files = e.target.files;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(event) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 mb-3';

                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.className = 'img-fluid rounded';
                    img.style.maxHeight = '150px';
                    img.style.objectFit = 'cover';

                    col.appendChild(img);
                    previewContainer.appendChild(col);
                };

                reader.readAsDataURL(file);
            }
        });

        // Edit Product - Fotoğraf Önizleme (Tüm edit form'lar için)
        document.querySelectorAll('.edit-product-images').forEach(function(input) {
            input.addEventListener('change', function(e) {
                const productId = this.getAttribute('data-product-id');
                const previewContainer = document.getElementById('editImagePreview-' + productId);
                previewContainer.innerHTML = '';

                const files = e.target.files;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();

                    reader.onload = function(event) {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 mb-3';

                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.className = 'img-fluid rounded';
                        img.style.maxHeight = '150px';
                        img.style.objectFit = 'cover';

                        col.appendChild(img);
                        previewContainer.appendChild(col);
                    };

                    reader.readAsDataURL(file);
                }
            });
        });

        // Edit Modal Açıldığında Product Bilgilerini Yükle (jQuery ile)
        console.log('Script loaded - Setting up modal events...');

        $('[id^="editProductModal-"]').on('show.bs.modal', function (e) {
            console.log('Modal opening:', this.id);
            const productId = this.id.replace('editProductModal-', '');
            console.log('Product ID:', productId);

            const modal = $(this);

            // API'den product bilgilerini çek
            fetch('https://localhost:7201/api/product/foredit/' + productId)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Product data loaded:', data);
                        console.log('Images:', data.images);

                        // Form alanlarını doldur
                        modal.find('[name="Name"]').val(data.name || '');
                        modal.find('[name="Price"]').val(data.price || '');
                        modal.find('[name="Details"]').val(data.details || '');
                        modal.find('[name="StockAmount"]').val(data.stockAmount || '');
                        modal.find('[name="CategoryId"]').val(data.categoryId || '');

                        // Mevcut fotoğrafları göster
                        const currentImagesContainer = document.getElementById('currentImages-' + productId);
                        currentImagesContainer.innerHTML = '';

                        console.log('Current images container:', currentImagesContainer);

                        if (data.images && data.images.length > 0) {
                            console.log('Found ' + data.images.length + ' images');
                            data.images.forEach(function(image) {
                                const col = document.createElement('div');
                                col.className = 'col-md-3 mb-3 position-relative';

                                const img = document.createElement('img');
                                img.src = 'https://localhost:7201' + image.url;
                                img.className = 'img-fluid rounded';
                                img.style.maxHeight = '150px';
                                img.style.objectFit = 'cover';

                                // Silme butonu
                                const deleteBtn = document.createElement('button');
                                deleteBtn.type = 'button';
                                deleteBtn.className = 'btn btn-danger btn-sm position-absolute';
                                deleteBtn.style.top = '5px';
                                deleteBtn.style.right = '20px';
                                deleteBtn.innerHTML = '&times;';
                                deleteBtn.onclick = function() {
                                    // Silinen fotoğraf ID'si için hidden input oluştur
                                    const container = document.getElementById('deletedImageIdsContainer-' + productId);
                                    const hiddenInput = document.createElement('input');
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.name = 'DeletedImageIds';
                                    hiddenInput.value = image.id;
                                    container.appendChild(hiddenInput);

                                    // Görsel olarak kaldır
                                    col.remove();
                                };

                                col.appendChild(img);
                                col.appendChild(deleteBtn);
                                currentImagesContainer.appendChild(col);
                            });
                        } else {
                            console.log('No images found for this product');
                        }

                        // DeletedImageIds container'ı temizle (modal her açıldığında)
                        document.getElementById('deletedImageIdsContainer-' + productId).innerHTML = '';
                    })
                    .catch(error => {
                        console.error('Error loading product:', error);
                        alert('Ürün bilgileri yüklenemedi.');
                    });
        });
    </script>
}